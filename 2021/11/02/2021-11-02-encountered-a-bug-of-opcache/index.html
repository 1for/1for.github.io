<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="keywords" content="æŠ€æœ¯åšå®¢" />
  <meta name="description" content="æŠ€æœ¯åšå®¢,emacs,golang,php,æœåŠ¡ç«¯,å¼€æºçˆ±å¥½è€…" />
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="dns-prefetch" href="https://busuanzi.ibruce.info">
  <link rel="dns-prefetch" href="https://at.alicdn.com">
  
  <link rel="dns-prefetch" href="https://widget.daovoice.io">
  <link rel="dns-prefetch" href="https://widget-static-cdn.daovoice.io">
  <link rel="dns-prefetch" href="https://im.daovoice.io">
  
  
  
  <link rel="stylesheet" type="text/css" href="/./style/main.css">
	<link rel="shortcut icon" href="/favicon.ico" title="Favicon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
	<title>è¸©ä¸­ä¸€ä¸ªå¤šå¹´å‰çš„ OPCache bug</title>
  
  
    <script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/123456.js","daovoice");daovoice('init',{app_id: "123456"});daovoice('update');
  </script>
  
<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <canvas id="pattern-placeholder" height="230"></canvas>
<div class="navbar-header">
  <a class="blog-title" href="/">å­¦ä»¥è‡´ç”¨</a>
  <a class="face-img" href="/">
    <img src="https://tva3.sinaimg.cn/crop.0.0.200.200.180/005Kc3C1jw8f2uep0hhkvj305k05k3yk.jpg">
  </a>
</div>
<main>
  <div class="article-title">
    
  
  <h1 class="title">
    è¸©ä¸­ä¸€ä¸ªå¤šå¹´å‰çš„ OPCache bug
  </h1>
  


    <ul class="article-info">
      <li>
        å‘å¸ƒ
        <time datetime="2021-11-02T09:50:35.000Z" itemprop="datePublished">2021-11-02</time>
      </li>
      <li>
        
    æ›´æ–° <time datetime="2021-11-02T09:37:32.079Z" itemprop="dateUpdated">2021-11-02</time>

      </li>
      <li id="busuanzi_container_page_pv">
        é˜…è¯» <span id="busuanzi_value_page_pv"></span>
      </li>
    </ul>
  </div>
  <div class="container">
    <div class="article">
      <div class="content">
        
        <p>ç”Ÿæ´»æ€»æ˜¯ä¼šåœ¨ä¸ç»æ„é—´ç»™ä½ ä¸€ä¸ªæš´å‡»ã€‚</p>
<p>â€œå¹³å°æŒ‚äº†ï¼ï¼â€ ï¼Œè¿è¥å‘æ¥æ¶ˆæ¯<br>æ‰“å¼€å¹³å°é¦–é¡µï¼Œç™½é¡µï¼<br>æƒ…å†µç´§æ€¥ï¼Œæ’æŸ¥æ—¶é—´æœªçŸ¥ï¼Œèµ¶ç´§å‡†å¤‡æŠŠæœ€è¿‘çš„æ”¹åŠ¨å›æ»šã€‚<br>è¯¢é—®ä¸€åœˆï¼Œ å•¥ï¼Ÿ è¿™ä¸ªé¡¹ç›®æ²¡å‘ç‰ˆï¼Ÿï¼ï¼<br>çº¿ä¸Šæ‘˜ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç¡¬ç€å¤´çš®è°ƒè¯•å§ã€‚<br>ä¸€é€šæ“ä½œ,å®‰ä¸Šç…§å¦–é•œï¼ŒæŠŠé”™è¯¯å…¨éƒ¨æ‰“å¼€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(E_ALL);</span><br><span class="line">ini_set(&#x27;display_errors&#x27;, &#x27;1&#x27;);</span><br><span class="line">ini_set(&#x27;display_startup_errors&#x27;, &#x27;1&#x27;);</span><br></pre></td></tr></table></figure>
<p>åŸå½¢æ¯•éœ²</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP Fatal error: Â Cannot redeclare class Foo in /data/pkg/foo_sdk-2.20.0.207/foo_client.php on line 20</span><br></pre></td></tr></table></figure>
<p>éƒ½è¯´é‡å¯å¤§æ³•å¥½ï¼Œ è¯•è¯•é‡å¯ php-fpm<br>Whatï¼Ÿï¼ å¥½äº†ï¼<br>ä¸€è„¸æ‡µé€¼ã€‚ã€‚ã€‚</p>
<hr>
<p>çº¿ä¸Šé—®é¢˜ç®—æ˜¯æš‚æ—¶è§£å†³ï¼Œ æ¥ä¸‹æ¥æ…¢æ…¢å•ƒè¿™ç–‘éš¾æ‚ç—‡ã€‚<br>ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>ä¸ºä»€ä¹ˆä¼šæŠ¥ â€œredeclare classâ€ çš„é”™è¯¯</li>
<li>ä¸ºä»€ä¹ˆé‡å¯å°±å¥½äº†</li>
</ol>
<hr>
<p>æ ¹æ®æŠ¥é”™ï¼Œ åœ¨æ–‡ä»¶ä¸­åŠ å…¥ debug_print_backtrace() å‡½æ•°å¯ä»¥çœ‹åˆ°è°ƒç”¨æ ˆï¼Œ å‘ç°æœ‰ä¸¤å¤„å¼•å…¥ foo_sdk çš„é€»è¾‘ï¼Œ ä½¿ç”¨çš„ä»£ç åˆ†åˆ«æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//ä»£ç 1. </span><br><span class="line">require_once(&#x27;/data/sdk/foo_sdk/foo_client.php&#x27;);</span><br><span class="line">//ä»£ç 2. </span><br><span class="line">require_once(realpath(&#x27;/data/sdk/foo_sdk/foo_client.php&#x27;));</span><br></pre></td></tr></table></figure>
<p>foo_sdk ç›®å½•æ˜¯ä¸€ä¸ªè½¯é“¾ï¼Œ æ¯ä¸€æ¬¡å‘ç‰ˆå°±é“¾æ¥åˆ°æœ€æ–°ç‰ˆæœ¬çš„ç›®å½•ä¸Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[vanmo@ /data/sdk ]$ ls -l</span><br><span class="line">lrwxrwxrwx Â 1 root Â  Â  Â  root Â  Â  Â  Â  45 10æœˆ 20 2021 foo_sdk -&gt; /data/pkg/foo_sdk-2.20.0.207</span><br><span class="line">[vanmo@ /data/sdk ]$ cd /data/pkg/</span><br><span class="line">[vanmo@ /data/pkg ]$ ls -l</span><br><span class="line">drwxrwxr-x Â 5 root Â  Â  Â  root Â  Â  Â  Â  45 10æœˆ 20 2021 foo_sdk-2.20.0.207</span><br><span class="line">drwxrwxr-x Â 5 root Â  Â  Â  root Â  Â  Â  Â  45 9æœˆ 21 2021 foo_sdk-2.20.0.206</span><br></pre></td></tr></table></figure>
<p>ä»æ—¶é—´ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œ æœ€è¿‘ foo_sdk è¿›è¡Œäº†ä¸€æ¬¡å‡çº§ã€‚ä»£ç 1è¿˜åœ¨åŠ è½½è€ç‰ˆæœ¬çš„ä»£ç ï¼Œ è€Œä»£ç 2åŠ è½½çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„ä»£ç ã€‚</p>
<blockquote>
<p>è¿™é‡Œéœ€è¦è¡¥å……ä¸€ç‚¹æˆ‘å¸é¡¹ç›®çš„ä¾èµ–éƒ¨ç½²çŸ¥è¯†ã€‚ å…¬å¸çš„åŸºç¡€æœåŠ¡ç»„æä¾›æœåŠ¡ç›¸å…³çš„SDKï¼Œ ä¸€å°æœåŠ¡å™¨ä¸Šå¤šä¸ªé¡¹ç›®ä¼šå…±ç”¨ä¸€ä»½SDKéƒ¨ç½²ï¼Œç”±æœåŠ¡çš„å¼€å‘äººå‘˜è¿›è¡Œç»´æŠ¤ã€‚ æ­¤å¤„æš‚ä¸è®ºè¿™å¥—æ–¹å¼çš„ä¼˜åŠ£ã€‚åœ¨æ­¤åœºæ™¯ä¸­ï¼Œ æœåŠ¡SDKçš„æ›´æ–°å¯¼è‡´ä¸šåŠ¡é¡¹ç›®å´©æºƒã€‚è¿™è®©ç»´æŠ¤ä¸šåŠ¡çš„äººå‘˜çŒä¸åŠé˜²ã€‚</p>
</blockquote>
<p>è‡³æ­¤åŸºæœ¬å°±å¯ä»¥ç¡®å®šäº†é—®é¢˜å¤ç°çš„æµç¨‹ï¼Œé‡å¯Fpm -&gt; è¯·æ±‚æ¥å£è®©ç›¸å…³ç¼“å­˜å»ºç«‹ -&gt; æ›´æ–°SDKç‰ˆæœ¬ï¼Œè½¯é“¾ç›®çš„åœ°è°ƒæ•´ -&gt; å†è¯·æ±‚æ¥å£ -&gt; æŠ¥é”™</p>
<p>é—®é¢˜é›†ä¸­åˆ°äº†  require_once , realpath ç›¸å…³å‡½æ•°çŸ¥è¯†ä¸Šã€‚</p>
<blockquote>
<p>require_once æºç è§£æ</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//https://raw.githubusercontent.com/php/php-src/PHP-5.6/Zend/zend_vm_execute.h line 2952</span><br><span class="line">resolved_path = zend_resolve_path(Z_STRVAL_P(inc_filename), Z_STRLEN_P(inc_filename) TSRMLS_CC); // è§£ææ–‡ä»¶è·¯å¾„</span><br><span class="line">if (resolved_path) &#123;</span><br><span class="line">    failure_retval = zend_hash_exists(&amp;EG(included_files), resolved_path, strlen(resolved_path)+1); // æ˜¯å¦å·²ç» included</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    resolved_path = Z_STRVAL_P(inc_filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ require_once çš„æ˜¯ä¸ªè½¯é“¾æ—¶ï¼Œä¼šé€šè¿‡ zend_resolve_path è·å–åˆ°è½¯é“¾æŒ‡å‘çš„çœŸå®é“¾æ¥ã€‚ è¿™ä¸­é—´æœ‰ php è‡ªå·±ç»´æŠ¤çš„ realpath_cacheï¼Œ å½“è½¯é“¾æŒ‡å‘è°ƒæ•´åï¼Œ realpath_cache å¾ˆå¿«å°±ä¼šæ›´æ–°ã€‚</p>
<p>require_once å’Œ realpath æœ¬èº«çš„é€»è¾‘æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯è¯¥é¡¹ç›®ä½¿ç”¨äº† Opcache æ‰©å±•ã€‚</p>
<p>å…³é—­opcacheï¼ŒæŠ¥é”™æ¶ˆå¤±</p>
<hr>
<p>éš¾é“ï¼ï¼ opcache æœ‰ bugï¼Ÿ è½¯é“¾ç›®æ ‡å˜åŒ–åï¼Œ opcache ä¸€ç›´æ²¡æœ‰æ›´æ–°å¯¹åº”è·¯å¾„çš„çœŸå®åœ°å€ã€‚</p>
<p>å…¶å®è¿™ä¸ªé—®é¢˜ï¼Œæ—©åœ¨ 2013å¹´å°±åœ¨githubæœ‰ç›¸å…³è®¨è®ºï¼ˆä¸€è„¸æƒ­æ„§ï¼‰</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zendtech/ZendOptimizerPlus/issues/126">https://github.com/zendtech/ZendOptimizerPlus/issues/126</a></p>
<p>æ€»ç»“ä¸€ä¸‹ç›¸å…³ä¿¡æ¯å°±æ˜¯ï¼Œ opcache å¹¶æ²¡æœ‰ä½¿ç”¨ php å†…ç½®çš„ realpath cacheï¼Œ è€Œæ˜¯è‡ªå·±æœ‰ä¸€å¥—ç¼“å­˜é€»è¾‘ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// https://github.com/zendtech/ZendOptimizerPlus/blob/3b16ca512290b0416baf02962beedc703147a97a/ZendAccelerator.c#L917</span><br><span class="line"></span><br><span class="line">/* Instead of resolving full real path name each time we need to identify file,</span><br><span class="line"> * we create a key that consist from requested file name, current working</span><br><span class="line"> * directory, current include_path, etc */</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°æ³¨é‡Šï¼Œå¯ä»¥æ¨æµ‹ç›¸å…³keyçš„è®¡ç®—æ–¹æ³•ä¸º<br>â€œPARENT_SCRIPT_FOLDER:SYMLINKED_PATH(require_onceé‡Œå¡«å†™çš„æ–‡ä»¶å):INCLUDE_PATH_CONTENTâ€</p>
<p>è¿™ä¸ªkeyå¯¹åº”çš„ç¼“å­˜æ°¸ä¸å¤±æ•ˆï¼Œé™¤éé‡å¯php-fpm</p>
<p>ç»“</p>
<h4 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h4><ul>
<li>[1]Â ã€Šå¦‚ä½•æ­£ç¡®å‘å¸ƒPHPä»£ç ã€‹<a target="_blank" rel="noopener" href="https://blog.huoding.com/2016/05/27/515">https://blog.huoding.com/2016/05/27/515</a></li>
<li>[2] ã€Š<br>Cache invalidation for scripts in symlinked foldersã€‹<a target="_blank" rel="noopener" href="https://github.com/zendtech/ZendOptimizerPlus/issues/126">https://github.com/zendtech/ZendOptimizerPlus/issues/126</a></li>
</ul>

      </div>
        <div class="support-author">
          <p>æ„Ÿè°¢æ‚¨çš„é˜…è¯»ã€‚ ğŸ™
          <a href="https://888.com/index.html" target="_blank">å…³äºè½¬è½½è¯·çœ‹è¿™é‡Œ</a>
            <!--<a class="btn-pay"  href="#pay-modal">Â¥ æ‰“èµæ”¯æŒ</a>-->
          </p>
        </div>
        <!--
            <div class="like ">
              <div class="like-button">
                <a id="like-note" href="">
                  <i class="icon-heart"></i>å–œæ¬¢
                </a>
              </div>
              <span id="likes-count">256</span>
            </div>
        -->
        <div class="otherLink">
          <div class="previous">
          </div>
          <div class="next">
          </div>
        </div>
        <div class="comments" id="comments">
          

        </div>
      </div>
    </div>
   </div>
</main>
<div class="footer">
  <div class="info">
    <p>
    <a target="_blank" rel="noopener" href="https://hexo.io"> Hexo </a> å¼ºåŠ›é©±åŠ¨ |
      <a target="_blank" rel="noopener" href="https://github.com/Youthink/hexo-themes-yearn"> Yearn </a>
      ä¸»é¢˜
    </p>
    <p>&copy;2013-2021 1forçš„åšå®¢</p>
  </div>
</div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>//console
  var consoleConfig = '\næ¬¢è¿è®¿é—® https://hufangyun.com ï¼Œå›´è§‚å°çŒ¿å¤§åœ£çš„åšå®¢(ã¥ï½¡â—•â€¿â€¿â—•ï½¡)ã¥ï¼\n,\næœ¬åšå®¢ä½¿ç”¨ %cHexo%c æ­å»ºï¼Œåšå®¢ä¸»é¢˜ä¸ºå°çŒ¿å¤§åœ£å¼€å‘çš„ %chexo-themes-yearn%c ~~~ ğŸ‰ğŸ‰ğŸ‰ \n\næºç  https://github.com/Youthink/hexo-themes-yearn \n\nå¦‚æœå–œæ¬¢å¯ä»¥ star æ”¯æŒä¸€ä¸‹ â¤ï¸~\n,\næ‰«æä¸‹é¢çš„äºŒç»´ç ï¼Œåœ¨æ‰‹æœºä¸ŠæŸ¥çœ‹åšå®¢ï¼\n,https://static.hufangyun.com/blog-url-qrcode-180-180.png,\n æƒ³çŸ¥é“è¿™ä¸ªæ•ˆæœå¦‚ä½•å®ç°çš„ï¼Ÿåšå®¢å†…æœç´¢ console å½©è›‹ ğŸš€ ï¼\n'.split(',');
  var canConsole = false;
  var consoleInfo = (function(consoleConfig) {
  if (!canConsole || !consoleConfig || consoleConfig.length < 1) {
    return;
  }
  var consoleColor = '#6190e8';
  var _console;
  var backgroundTextStyle = 'padding: 1px 5px;color: #fff;background: ' + consoleColor + ';'
  var textStyle = 'color: ' + consoleColor + ';';

  consoleConfig.map(o => {
    var num = (o.match(/%c/g) || []).length;
    if(/^http(s)?:\/\//.test(o)) {
      console.log('%c     ', 'background: url(' + o + ') no-repeat left center;font-size: 180px;');
      return;
    }
    if (num > 0) {
      var logArguments = [];
      for (var i = 0; i < num; i++) {
        if (i % 2 === 0) {
          logArguments.push(backgroundTextStyle);
        } else {
          logArguments.push(textStyle);
        }
      }
      (_console = console).log.apply(_console, ['%c' + o, textStyle].concat(logArguments));
      return;
    }
    console.log('%c' + o, textStyle);
  });
}(consoleConfig));</script><script type="text/javascript" src="/./js/main.js"></script>

  <script src="//at.alicdn.com/t/font_159214_mvtxvg9me9.js"></script>
</body>
</html>
