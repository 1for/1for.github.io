<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="keywords" content="技术博客" />
  <meta name="description" content="技术博客,emacs,golang,php,服务端,开源爱好者" />
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="dns-prefetch" href="https://busuanzi.ibruce.info">
  <link rel="dns-prefetch" href="https://at.alicdn.com">
  
  <link rel="dns-prefetch" href="https://widget.daovoice.io">
  <link rel="dns-prefetch" href="https://widget-static-cdn.daovoice.io">
  <link rel="dns-prefetch" href="https://im.daovoice.io">
  
  
  
  <link rel="stylesheet" type="text/css" href="/./style/main.css">
	<link rel="shortcut icon" href="/favicon.ico" title="Favicon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
	<title>POD内存问题排查</title>
  
  
    <script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/123456.js","daovoice");daovoice('init',{app_id: "123456"});daovoice('update');
  </script>
  
<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <canvas id="pattern-placeholder" height="230"></canvas>
<div class="navbar-header">
  <a class="blog-title" href="/">学以致用</a>
  <a class="face-img" href="/">
    <img src="https://tva3.sinaimg.cn/crop.0.0.200.200.180/005Kc3C1jw8f2uep0hhkvj305k05k3yk.jpg">
  </a>
</div>
<main>
  <div class="article-title">
    
  
  <h1 class="title">
    POD内存问题排查
  </h1>
  


    <ul class="article-info">
      <li>
        发布
        <time datetime="2021-02-25T08:50:35.000Z" itemprop="datePublished">2021-02-25</time>
      </li>
      <li>
        
    更新 <time datetime="2021-11-03T08:55:50.729Z" itemprop="dateUpdated">2021-11-03</time>

      </li>
      <li id="busuanzi_container_page_pv">
        阅读 <span id="busuanzi_value_page_pv"></span>
      </li>
    </ul>
  </div>
  <div class="container">
    <div class="article">
      <div class="content">
        
        <h2 id="起"><a href="#起" class="headerlink" title="起"></a>起</h2><p>最近新上线了一个golang项目， 使用公司的k8s。运行一段时间后，发现线上几个pod的内存使用量持续上涨。 为搞清楚其原因以及影响，花了几天的时间研究了一下。</p>
<p><img src="https://user-images.githubusercontent.com/2173159/109094313-b30f1380-7754-11eb-8894-0a8f4251d7dc.png"></p>
<h2 id="承"><a href="#承" class="headerlink" title="承"></a>承</h2><p>本着有问题先反省自身的原则，先看看程序中有什么地方内存泄露了。</p>
<h3 id="第一回合"><a href="#第一回合" class="headerlink" title="第一回合"></a>第一回合</h3><p>golang坊间有传</p>
<blockquote>
<p>十次内存泄露，九次来自协程</p>
</blockquote>
<p>要看是否是协程引起的内存泄露， 比较好的方式是使用 golang的性能分析工具pprof。 pprof记录了程序运行过程中的CPU使用情况、内存使用情况、协程运行情况。 此处我们直接观察程序协程的运行情况， 看协程数量是否是随着时间不断增长的。</p>
<p>按照大彬的文章 <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000019222661">实战GO内存泄露</a><sup>[1]</sup> 一通操作 ， 发现协程数量虽有波动， 但相对比较稳定。</p>
<p>首回合终，未果。</p>
<h3 id="第二回合"><a href="#第二回合" class="headerlink" title="第二回合"></a>第二回合</h3><p>检查程序自身的内存占用情况</p>
<p>通过 pprof heap 模块查看程序中占用内存最多代码段</p>
<blockquote>
<p>此处要注意的是， golang 程序自身的垃圾回收间隔是2分钟， 每次操作完之后等待2分钟，再去看相关的数据。</p>
</blockquote>
<p>从数据看，垃圾回收后，内存数据涨幅不大， 这个从监控图中的常驻内存曲线（rss）也可以看出来<br><img src="https://user-images.githubusercontent.com/2173159/109095129-1c435680-7756-11eb-85ea-5805634bd9af.png"></p>
<p>次回合终，程序中未发现问题。</p>
<h2 id="转"><a href="#转" class="headerlink" title="转"></a>转</h2><p>爬几层楼换换脑子回来再战。</p>
<p>继续排查过程中看到煎鱼的一篇文章 <a target="_blank" rel="noopener" href="https://eddycjy.com/posts/why-container-memory-exceed2/">为什么容器内存占用居高不下，频频 OOM（续）</a><sup>[2]</sup>，似乎找到了眉目，开始探索是否是操作系统的Cache问题。</p>
<h4 id="先查看POD内存占用情况"><a href="#先查看POD内存占用情况" class="headerlink" title="先查看POD内存占用情况"></a>先查看POD内存占用情况</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># free -m</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:         128412       53226       71449           0        3736        3817</span><br><span class="line">Swap:             0           0           0</span><br></pre></td></tr></table></figure>
<p>哇撒，128G的内存，显然是宿主机的信息， 不可用。 <br>至于容器中的free命令为什么显示了宿主机的信息， 暂略过不表，咱通过其他方式查询</p>
<h4 id="POD-内存统计的几个维度以及说明"><a href="#POD-内存统计的几个维度以及说明" class="headerlink" title="POD 内存统计的几个维度以及说明"></a>POD 内存统计的几个维度以及说明</h4><table>
<thead>
<tr>
<th>内存指标</th>
<th>计算方式</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>container_memory_usage_bytes</td>
<td>memory.usage_in_bytes = memory.stat[rss] + memory.stat[cache] + memory.kmem.usage_in_bytes</td>
<td></td>
</tr>
<tr>
<td>container_memory_working_set_bytes</td>
<td>working_set = memory.usage_in_bytes - total_inactive_file</td>
<td><a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/blob/master/container/libcontainer/handler.go#L821">源码参考</a></td>
</tr>
<tr>
<td>container_memory_rss</td>
<td>memory.stat[rss]</td>
<td><a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/blob/master/container/libcontainer/handler.go#L798">源码参考</a></td>
</tr>
<tr>
<td>container_memory_cache</td>
<td>memory.stat[cache]</td>
<td><a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/blob/master/container/libcontainer/handler.go#L797">源码参考</a></td>
</tr>
</tbody></table>
<p>可以这样理解， POD的 内存usage指标包括了 rss 以及 cache部分，rss 部分之前看过曲线了，是相对稳定的， 那问题就出在 cache 部分了</p>
<h4 id="尝试手动清理-Cache"><a href="#尝试手动清理-Cache" class="headerlink" title="尝试手动清理 Cache"></a>尝试手动清理 Cache</h4><p>引用<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt">内核文档</a><sup>[3]</sup>里面的一段</p>
<blockquote>
<p>To free pagecache:<br>        echo 1 &gt; /proc/sys/vm/drop_caches<br>To free reclaimable slab objects (includes dentries and inodes):<br>        echo 2 &gt; /proc/sys/vm/drop_caches<br>To free slab objects and pagecache:<br>        echo 3 &gt; /proc/sys/vm/drop_caches<br>…<br>To disable them, echo 4 (bit 2) into drop_caches.</p>
</blockquote>
<p>设置 drop_caches 为 1 之后， container_memory_working_set_bytes 曲线如下图。 <br><img src="https://user-images.githubusercontent.com/2173159/109097897-37fd2b80-775b-11eb-980d-8bb7b3722804.png"></p>
<h2 id="合"><a href="#合" class="headerlink" title="合"></a>合</h2><p>至此，我们基本捋清楚POD内存的相关指标。</p>
<p>结合应用本身， 这是个提供 web api 和 grpc 服务的业务应用，主要是短链接并发。 底层不断建立 socket 连接进行 write 和 read，socket在Linux 下也就是一个文件，只要读写磁盘文件，就会被Linux 内核缓存。  </p>
<h4 id="最后几个疑问"><a href="#最后几个疑问" class="headerlink" title="最后几个疑问"></a>最后几个疑问</h4><ul>
<li><p>那内存持续上涨会有什么问题吗？<br>  在我们的场景下， 是不会有影响的。 因为应用本身占用的内存很少，也不存在任何泄露问题。 当内存使用量（rss + cache）超出限制时， 操作系统会自动回收cache部分。</p>
</li>
<li><p>那如果应用确实存在泄漏，并超出限制了呢？<br>  容器本身有 OOM Killer 机制， 会主动杀死正在运行的进程释放内存。 具体的规则可以阅读文章<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/315468">容器内存：我的容器为什么被杀了？</a><sup>[4]</sup></p>
<h4 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h4></li>
<li><p>[1] 《实战GO内存泄露》<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000019222661">https://segmentfault.com/a/1190000019222661</a></p>
</li>
<li><p>[2] 《为什么容器内存占用居高不下，频频 OOM（续）》<a target="_blank" rel="noopener" href="https://eddycjy.com/posts/why-container-memory-exceed2/">https://eddycjy.com/posts/why-container-memory-exceed2/</a></p>
</li>
<li><p>[3]  <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt">https://www.kernel.org/doc/Documentation/sysctl/vm.txt</a> </p>
</li>
<li><p>[4] 《容器内存：我的容器为什么被杀了？》<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/315468">https://time.geekbang.org/column/article/315468</a></p>
</li>
<li><p>[5] 《容器内存分析》 <a target="_blank" rel="noopener" href="https://qinng.now.sh/container-memory/">https://qinng.now.sh/container-memory/</a></p>
</li>
</ul>

      </div>
        <div class="support-author">
          <p>感谢您的阅读。 🙏
          <a href="https://888.com/index.html" target="_blank">关于转载请看这里</a>
            <!--<a class="btn-pay"  href="#pay-modal">¥ 打赏支持</a>-->
          </p>
        </div>
        <!--
            <div class="like ">
              <div class="like-button">
                <a id="like-note" href="">
                  <i class="icon-heart"></i>喜欢
                </a>
              </div>
              <span id="likes-count">256</span>
            </div>
        -->
        <div class="otherLink">
          <div class="previous">
          </div>
          <div class="next">
          </div>
        </div>
        <div class="comments" id="comments">
          

        </div>
      </div>
    </div>
   </div>
</main>
<div class="footer">
  <div class="info">
    <p>
    <a target="_blank" rel="noopener" href="https://hexo.io"> Hexo </a> 强力驱动 |
      <a target="_blank" rel="noopener" href="https://github.com/Youthink/hexo-themes-yearn"> Yearn </a>
      主题
    </p>
    <p>&copy;2013-2021 1for的博客</p>
  </div>
</div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>//console
  var consoleConfig = '\n欢迎访问 https://hufangyun.com ，围观小猿大圣的博客(づ｡◕‿‿◕｡)づ！\n,\n本博客使用 %cHexo%c 搭建，博客主题为小猿大圣开发的 %chexo-themes-yearn%c ~~~ 🎉🎉🎉 \n\n源码 https://github.com/Youthink/hexo-themes-yearn \n\n如果喜欢可以 star 支持一下 ❤️~\n,\n扫描下面的二维码，在手机上查看博客！\n,https://static.hufangyun.com/blog-url-qrcode-180-180.png,\n 想知道这个效果如何实现的？博客内搜索 console 彩蛋 🚀 ！\n'.split(',');
  var canConsole = false;
  var consoleInfo = (function(consoleConfig) {
  if (!canConsole || !consoleConfig || consoleConfig.length < 1) {
    return;
  }
  var consoleColor = '#6190e8';
  var _console;
  var backgroundTextStyle = 'padding: 1px 5px;color: #fff;background: ' + consoleColor + ';'
  var textStyle = 'color: ' + consoleColor + ';';

  consoleConfig.map(o => {
    var num = (o.match(/%c/g) || []).length;
    if(/^http(s)?:\/\//.test(o)) {
      console.log('%c     ', 'background: url(' + o + ') no-repeat left center;font-size: 180px;');
      return;
    }
    if (num > 0) {
      var logArguments = [];
      for (var i = 0; i < num; i++) {
        if (i % 2 === 0) {
          logArguments.push(backgroundTextStyle);
        } else {
          logArguments.push(textStyle);
        }
      }
      (_console = console).log.apply(_console, ['%c' + o, textStyle].concat(logArguments));
      return;
    }
    console.log('%c' + o, textStyle);
  });
}(consoleConfig));</script><script type="text/javascript" src="/./js/main.js"></script>

  <script src="//at.alicdn.com/t/font_159214_mvtxvg9me9.js"></script>
</body>
</html>
